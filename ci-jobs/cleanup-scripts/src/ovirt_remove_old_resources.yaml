---
  - name: remove old resources from the oVirt CI engine
    hosts: localhost
    connection: local
    vars:
      max_hours: 10
      vms_to_exclude:
        - proxy-vm
        - ovirt-proxy-VM
        - upi-proxy-vm

      templates_to_exclude_regex: ovirt1.*
      templates_to_exclude_list:
        - Blank
        - centos-7
    tasks:
      - name: collect engine general info
        uri:
          url: "{{ lookup('env','OVIRT_ENGINE_URL') }}"
          method: GET
          user: "{{ lookup('env','OVIRT_ENGINE_USERNAME') }}"
          password: "{{ lookup('env','OVIRT_ENGINE_PASSWORD') }}"

          body_format: json
          status_code: 200
          validate_certs: no
          headers:
            Content-Type: "application/json"
            Accept: "application/json"
        register: token_json
      - name: collect VM information using engine API
        uri:
          url: "{{ lookup('env','OVIRT_ENGINE_URL') }}/vms"
          method: GET
          user: "{{ lookup('env','OVIRT_ENGINE_USERNAME') }}"
          password: "{{ lookup('env','OVIRT_ENGINE_PASSWORD') }}"

          body_format: json
          status_code: 200
          validate_certs: no
          headers:
            Content-Type: "application/json"
            Accept: "application/json"
        register: vms_json
        
      - name: delete old vms
        include_tasks: delete_vm_if_older.yaml
        vars:
          vm_creation_epoch: "{{ item['creation_time'] | int }}"
          engine_time: "{{token_json.json.time | int}}"
          seconds_limit: "{{ max_hours*3600  }}"
          vm_id: "{{ item['id'] }}"
          vm_name: "{{ item['name'] }}"
        loop: "{{ vms_json.json.vm }}"
        when: "item['name'] not in vms_to_exclude"